#!/bin/sh -x

TEST_DIR=$1
shift

rm -rf $TEST_DIR
mkdir -p $TEST_DIR

# now run gnome-keyring
gnome-keyring-daemon -r -d

# we need to set this otherwise mission-control doesn't work properly
dconf write /org/gnome/empathy/use-conn false

# start mission-control-5 manually to stop it before removing temporary directories
/usr/lib/telepathy/mission-control-5 &
MC_PID=$!

# start the mock connection manager
@CMAKE_BINARY_DIR@/tests/common/mock/telepathy-mock &
MOCK_PID=$!

# wait 1 sec for the mock to start up
sleep 1

# add one generic account
mc-tool add mock/mock account0

# and one phone account
mc-tool add mock/ofono account0

@CMAKE_BINARY_DIR@/handler/telephony-service-handler &

HANDLER_PID=$!

$@
RESULT=$?

# FIXME: check the variables and things that should not be started
kill -9 $HANDLER_PID
kill -9 $MOCK_PID
kill -9 $MC_PID

# remove the test dir
rm -rf $TEST_DIR

# in case the test fails, output the xml file just to help debugging
if [ $RESULT -ne 0 ]; then
    cat @CMAKE_BINARY_DIR@/test_`basename $1`.xml
fi

return $RESULT
