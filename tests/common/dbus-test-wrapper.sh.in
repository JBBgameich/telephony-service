#!/bin/sh -x

# export the home folder to somewhere in /tmp
TMPDIR=/tmp/telephony_service_test_home
rm -rf $TMPDIR
mkdir -p $TMPDIR
export HOME=$TMPDIR

# now run gnome-keyring
gnome-keyring-daemon -r -d

# we need to set this otherwise mission-control doesn't work properly
dconf write /org/gnome/empathy/use-conn false

# start the mock connection manager
@CMAKE_BINARY_DIR@/tests/common/mock/telepathy-mock &
MOCK_PID=$!

# wait 1 sec for the mock to start up
sleep 1

# add one generic account
mc-tool add mock/mock account0

# and one phone account
mc-tool add mock/ofono account0

@CMAKE_BINARY_DIR@/handler/telephony-service-handler &

HANDLER_PID=$!

$@
RESULT=$?

# FIXME: check the variables and things that should not be started
kill -9 $HANDLER_PID
kill -9 $MOCK_PID

return $RESULT
